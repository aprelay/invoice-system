<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Automation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
      .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
      .status-running { background-color: #10b981; animation: pulse 2s infinite; }
      .status-paused { background-color: #f59e0b; }
      @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-50">
    <div class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white py-6 px-6 shadow-xl">
        <div class="container mx-auto max-w-7xl">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center">
                        <i class="fas fa-robot mr-3"></i>Email Automation Dashboard
                    </h1>
                    <p class="text-purple-100 text-sm mt-1">
                        ü§ñ 120 emails/day | 15-25 min delays | 3-5 batch sizes | 10-account rotation
                    </p>
                </div>
                <a href="/" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-purple-50 transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Invoice System
                </a>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-tachometer-alt mr-3 text-purple-600"></i>System Status
                    </h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Status:</span>
                            <span id="systemStatus" class="flex items-center">
                                <span class="status-indicator status-paused"></span>
                                <span class="font-bold text-orange-600">LOADING...</span>
                            </span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Emails in Queue:</span>
                            <span id="queueCount" class="font-bold text-purple-600">0</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Last Send:</span>
                            <span id="lastSend" class="font-bold text-gray-600">Never</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Next Send:</span>
                            <span id="nextSend" class="font-bold text-blue-600">-</span>
                        </div>
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button id="pauseBtn" onclick="toggleAutomation()" 
                                class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-bold transition shadow-md hidden">
                            <i class="fas fa-pause mr-2"></i>PAUSE
                        </button>
                        <button id="resumeBtn" onclick="toggleAutomation()" 
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold transition shadow-md">
                            <i class="fas fa-play mr-2"></i>RESUME
                        </button>
                        <button onclick="manualTrigger()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-bold transition shadow-md">
                            <i class="fas fa-bolt mr-2"></i>SEND NOW
                        </button>
                        <button onclick="refreshStatus()" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-bold transition shadow-md">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-link mr-3 text-blue-600"></i>URL Rotation (Auto-Cycle)
                    </h2>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-3">
                            <i class="fas fa-info-circle mr-1"></i>URLs rotate automatically with each batch. Add up to 10 URLs.
                        </p>
                        <div id="urlList" class="space-y-2 mb-4">
                            <p class="text-gray-500 text-sm">Loading...</p>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Add New URL</label>
                        <div class="flex gap-2">
                            <input type="url" id="newUrl" placeholder="https://example.com/invoice" 
                                   class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button onclick="addUrl()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus mr-2"></i>Add
                            </button>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-lightbulb mr-2"></i><strong>Current Position:</strong> <span id="currentUrlPosition">Loading...</span>
                        </p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-plus-circle mr-3 text-green-600"></i>Add Email Batch
                    </h2>

                    <form id="batchForm" onsubmit="addBatch(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Email Addresses (one per line)</label>
                            <textarea id="emails" rows="5" required placeholder="customer1@example.com
customer2@domain.com
customer3@company.org" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
                            <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle"></i> Each email on a new line</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Work Order</label>
                                <input type="text" id="workOrder" required placeholder="WO-12345" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Reference</label>
                                <input type="text" id="reference" required placeholder="REF-67890" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Service</label>
                            <input type="text" id="service" required placeholder="HVAC Maintenance" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Due Date</label>
                                <input type="date" id="dueDate" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Contact Email</label>
                                <input type="email" id="contactEmail" placeholder="support@company.com" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold transition shadow-md">
                            <i class="fas fa-plus-circle mr-2"></i>Add to Queue
                        </button>
                    </form>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-3 text-green-600"></i>Today's Stats
                    </h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Sent:</span>
                            <span id="todaySent" class="text-2xl font-bold text-green-600">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Failed:</span>
                            <span id="todayFailed" class="text-2xl font-bold text-red-600">0</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Batches:</span>
                            <span id="todayBatches" class="text-2xl font-bold text-purple-600">0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cog mr-3 text-gray-600"></i>Configuration
                    </h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Delay Range:</span>
                            <span class="font-bold">15-25 min</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Batch Size:</span>
                            <span class="font-bold">3-5 emails</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Daily Target:</span>
                            <span class="font-bold">120 emails</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Accounts:</span>
                            <span class="font-bold">10 rotating</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Hours:</span>
                            <span class="font-bold">Mon-Fri 8am-6pm</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t">
                        <button onclick="syncAccounts()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold transition text-sm">
                            <i class="fas fa-sync mr-2"></i>Sync OAuth Accounts
                        </button>
                        <p class="text-xs text-gray-500 mt-2 text-center">Syncs up to 10 accounts from /accounts page</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-list mr-3 text-blue-600"></i>Recent Queue
                    </h2>
                    <div id="recentQueue" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-sm text-center py-4">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
      let isPaused = true;
      
      async function loadDashboard() {
        try {
          const [status, urls, queue, metrics] = await Promise.all([
            fetch('/api/automation/status').then(r => r.json()),
            fetch('/api/automation/urls').then(r => r.json()),
            fetch('/api/automation/queue').then(r => r.json()),
            fetch('/api/automation/metrics').then(r => r.json())
          ]);
          
          updateStatus(status);
          updateUrls(urls);
          updateQueue(queue);
          updateMetrics(metrics);
        } catch (error) {
          console.error('Failed to load dashboard:', error);
          document.getElementById('systemStatus').innerHTML = '<span class="font-bold text-red-600">ERROR</span>';
        }
      }
      
      function updateStatus(status) {
        const config = status.config || {};
        isPaused = config.is_paused === 1;
        
        document.getElementById('systemStatus').innerHTML = isPaused
          ? '<span class="status-indicator status-paused"></span><span class="font-bold text-orange-600">PAUSED</span>'
          : '<span class="status-indicator status-running"></span><span class="font-bold text-green-600">RUNNING</span>';
        
        document.getElementById('pauseBtn').classList.toggle('hidden', isPaused);
        document.getElementById('resumeBtn').classList.toggle('hidden', !isPaused);
        document.getElementById('queueCount').textContent = status.queue_count || 0;
        
        const lastSend = config.last_send_time ? new Date(config.last_send_time + 'Z').toLocaleString() : 'Never';
        const nextSend = config.next_send_time ? new Date(config.next_send_time + 'Z').toLocaleString() : '-';
        
        document.getElementById('lastSend').textContent = lastSend;
        document.getElementById('nextSend').textContent = nextSend;
        document.getElementById('currentUrlPosition').textContent = 'URL ' + ((config.current_url_position || 0) + 1);
      }
      
      function updateUrls(urls) {
        const list = document.getElementById('urlList');
        if (!urls || urls.length === 0) {
          list.innerHTML = '<p class="text-gray-500 text-sm">No URLs configured. Add URLs below.</p>';
          return;
        }
        
        list.innerHTML = urls.map((url, idx) => 
          '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">' +
          '<div class="flex items-center flex-1">' +
          '<span class="text-xs font-bold text-gray-500 mr-2">' + (idx + 1) + '.</span>' +
          '<span class="text-sm text-gray-700 truncate">' + url.url + '</span>' +
          '</div>' +
          '<div class="flex items-center gap-2">' +
          '<span class="text-xs text-gray-500">' + url.usage_count + ' uses</span>' +
          '<button onclick="deleteUrl(' + url.id + ')" class="text-red-500 hover:text-red-700">' +
          '<i class="fas fa-trash text-xs"></i>' +
          '</button>' +
          '</div>' +
          '</div>'
        ).join('');
      }
      
      function updateQueue(queue) {
        const list = document.getElementById('recentQueue');
        if (!queue || queue.length === 0) {
          list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No emails in queue</p>';
          return;
        }
        
        list.innerHTML = queue.slice(0, 10).map(item => {
          let statusClass = item.status === 'sent' ? 'bg-green-100 text-green-800' :
                           item.status === 'failed' ? 'bg-red-100 text-red-800' :
                           'bg-yellow-100 text-yellow-800';
          return '<div class="p-2 bg-gray-50 rounded-lg">' +
            '<div class="flex items-center justify-between">' +
            '<span class="text-sm font-medium text-gray-700 truncate">' + item.email + '</span>' +
            '<span class="text-xs px-2 py-1 rounded ' + statusClass + '">' + item.status + '</span>' +
            '</div>' +
            '<div class="text-xs text-gray-500 mt-1">' + item.work_order + ' | ' + item.service + '</div>' +
            '</div>';
        }).join('');
      }
      
      function updateMetrics(metrics) {
        document.getElementById('todaySent').textContent = metrics.emails_sent || 0;
        document.getElementById('todayFailed').textContent = metrics.emails_failed || 0;
        document.getElementById('todayBatches').textContent = metrics.batches_completed || 0;
      }
      
      async function toggleAutomation() {
        try {
          const response = await fetch('/api/automation/toggle', { method: 'POST' });
          const result = await response.json();
          if (result.success) {
            await refreshStatus();
            alert('‚úÖ ' + result.message);
          } else {
            alert('‚ùå Error: ' + result.error);
          }
        } catch (error) {
          alert('Failed to toggle automation: ' + error.message);
        }
      }
      
      async function manualTrigger() {
        if (!confirm('Manually trigger email sending now? This will ignore the delay timer.')) return;
        try {
          const response = await fetch('/api/automation/trigger', { method: 'POST' });
          const result = await response.json();
          if (result.success) {
            alert('‚úÖ Automation triggered! Check queue status in a few moments.');
            await refreshStatus();
          } else {
            alert('‚ùå Error: ' + result.error);
          }
        } catch (error) {
          alert('Failed to trigger: ' + error.message);
        }
      }
      
      async function addUrl() {
        const url = document.getElementById('newUrl').value.trim();
        if (!url) {
          alert('Please enter a URL');
          return;
        }
        
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          alert('URL must start with http:// or https://');
          return;
        }
        
        try {
          const response = await fetch('/api/automation/urls', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });
          const result = await response.json();
          if (result.success) {
            document.getElementById('newUrl').value = '';
            await loadDashboard();
            alert('‚úÖ URL added successfully!');
          } else {
            alert('‚ùå Error: ' + result.error);
          }
        } catch (error) {
          alert('Failed to add URL: ' + error.message);
        }
      }
      
      async function deleteUrl(id) {
        if (!confirm('Remove this URL from rotation?')) return;
        
        try {
          const response = await fetch('/api/automation/urls/' + id, { method: 'DELETE' });
          const result = await response.json();
          if (result.success) {
            await loadDashboard();
            alert('‚úÖ URL removed successfully!');
          } else {
            alert('‚ùå Error: ' + result.error);
          }
        } catch (error) {
          alert('Failed to delete URL: ' + error.message);
        }
      }
      
      async function addBatch(event) {
        event.preventDefault();
        
        const emailsText = document.getElementById('emails').value;
        const emails = emailsText.split('\n').map(e => e.trim()).filter(e => e.length > 0);
        
        if (emails.length === 0) {
          alert('Please enter at least one email address');
          return;
        }
        
        const data = {
          emails,
          workOrder: document.getElementById('workOrder').value,
          reference: document.getElementById('reference').value,
          service: document.getElementById('service').value,
          dueDate: document.getElementById('dueDate').value,
          contactEmail: document.getElementById('contactEmail').value
        };
        
        try {
          const response = await fetch('/api/automation/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const result = await response.json();
          if (result.success) {
            alert('‚úÖ Added ' + emails.length + ' emails to queue!');
            document.getElementById('batchForm').reset();
            await loadDashboard();
          } else {
            alert('‚ùå Error: ' + result.error);
          }
        } catch (error) {
          alert('Failed to add batch: ' + error.message);
        }
      }
      
      async function syncAccounts() {
        if (!confirm('Sync OAuth accounts from /accounts page to automation system?')) return;
        
        try {
          const response = await fetch('/api/automation/sync-accounts', { method: 'POST' });
          const result = await response.json();
          if (result.success) {
            alert('‚úÖ ' + result.message);
          } else {
            alert('‚ùå Failed: ' + result.error);
          }
        } catch (error) {
          alert('Failed to sync accounts: ' + error.message);
        }
      }
      
      async function refreshStatus() {
        await loadDashboard();
      }
      
      // Auto-refresh every 10 seconds
      setInterval(refreshStatus, 10000);
      
      // Initial load
      loadDashboard();
    </script>
</body>
</html>
